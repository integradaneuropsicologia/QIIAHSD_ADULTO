<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>QIIAHSD_ADULTO</title>
<style>
  :root{
    --bg:#f3f4f6;
    --card:#ffffff;
    --line:#e5e7eb;
    --text:#0f172a;
    --muted:#6b7280;
    --pri:#6d28d9;
    --ok:#10b981;
    --err:#b91c1c;
    --warn:#f59e0b;
    --surface:#f9fafb;
    --chip:#eef2ff;
    --chipHover:#e0e7ff;
    --chipSel:#e0e7ff;
    --ok-bg:#ecfdf3;
    --ok-border:#bbf7d0;
    --ok-text:#166534;
    --err-bg:#fef2f2;
    --err-border:#fecaca;
    --err-text:#7f1d1d;
    --warn-bg:#fffbeb;
    --warn-border:#fef3c7;
    --warn-text:#92400e;
  }

  [data-theme="dark"]{
    --bg:#0e1625;
    --card:#14213b;
    --line:#2b3f66;
    --text:#f8fafc;
    --muted:#cbd5e1;
    --pri:#6d28d9;
    --ok:#10b981;
    --err:#ef4444;
    --warn:#f59e0b;
    --surface:#0b1220;
    --chip:#0b1220;
    --chipHover:#0f1a2e;
    --chipSel:#1e293b;
    --ok-bg:#06351f;
    --ok-border:#0e6c45;
    --ok-text:#c8ffe3;
    --err-bg:#3b0d0d;
    --err-border:#7f1d1d;
    --err-text:#ffd5d5;
    --warn-bg:#3a2903;
    --warn-border:#885e09;
    --warn-text:#ffe6b0;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background:var(--bg);
    color:var(--text);
    font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    transition:background .2s ease,color .2s ease;
  }
  .wrap{max-width:1024px;margin:20px auto;padding:0 16px}
  .card{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:14px;
    padding:18px;
    box-shadow:0 18px 40px rgba(15,23,42,.15);
  }

  .header{
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:12px;
    margin-bottom:6px;
  }
  .header-main{flex:1 1 auto}
  h1{margin:0 0 6px;font-size:1.45rem}
  .muted{color:var(--muted)}

  .theme-btn{
    align-self:flex-start;
    padding:8px 12px;
    border-radius:999px;
    border:1px solid var(--line);
    background:transparent;
    color:var(--text);
    font-size:.85rem;
    cursor:pointer;
    display:inline-flex;
    align-items:center;
    gap:6px;
    white-space:nowrap;
  }
  .theme-btn:hover{background:var(--surface)}

  @media (max-width:720px){
    .header{flex-direction:column-reverse;align-items:flex-start}
  }

  .grid-info{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:12px;
    margin:12px 0 6px;
  }
  @media (max-width:720px){.grid-info{grid-template-columns:1fr}}
  .info{
    background:var(--surface);
    border:1px solid var(--line);
    border-radius:12px;
    padding:12px;
  }
  .info b{
    display:block;
    margin-bottom:4px;
    color:var(--muted);
    font-size:.8rem;
    text-transform:uppercase;
    letter-spacing:.03em;
  }

  .section{
    margin:18px 0 8px;
    padding:10px 12px;
    border:1px solid var(--line);
    border-radius:12px;
    background:var(--surface);
    font-weight:700;
  }

  .item{
    border:1px solid var(--line);
    border-radius:12px;
    padding:12px;
    background:var(--surface);
    margin-bottom:12px;
  }
  .stem{font-size:1rem;margin-bottom:10px}
  .choices{
    display:grid;
    grid-template-columns:repeat(2,minmax(220px,1fr));
    gap:10px;
  }
  @media (max-width:820px){ .choices{grid-template-columns:1fr} }

  .opt{
    display:flex;
    align-items:center;
    gap:10px;
    padding:10px 12px;
    border:1px solid var(--line);
    border-radius:12px;
    background:var(--chip);
    cursor:pointer;
    transition:background .15s ease, border-color .15s ease, transform .05s ease;
  }
  .opt:hover{
    background:var(--chipHover);
    border-color:#4f70ff;
    transform:translateY(-1px);
  }
  .opt input{
    appearance:none;
    -webkit-appearance:none;
    width:0;height:0;
    position:absolute;
    opacity:0;
  }
  .opt span{font-weight:600}
  .opt small{opacity:.8}
  .opt:has(input:checked){
    background:var(--chipSel);
    border-color:#6d28d9;
    box-shadow:0 0 0 1px #6d28d9 inset;
  }

  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chip{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:8px 10px;
    border:1px solid var(--line);
    border-radius:999px;
    background:var(--chip);
    cursor:pointer;
  }
  .chip input{transform:scale(1.05)}
  .chip:hover{background:var(--chipHover);border-color:#4f70ff}

  .row{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
  }
  .row input[type="text"]{
    flex:1;
    min-width:220px;
    padding:10px;
    border-radius:10px;
    border:1px solid var(--line);
    background:var(--surface);
    color:var(--text);
  }

  .legend{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    margin:6px 0 12px;
  }
  .pill{
    display:inline-block;
    padding:4px 8px;
    border-radius:999px;
    border:1px solid var(--line);
    background:var(--surface);
    font-size:.86rem;
  }

  .btn{
    display:inline-flex;
    align-items:center;
    gap:10px;
    background:var(--pri);
    border:none;
    color:#fff;
    padding:12px 16px;
    border-radius:12px;
    cursor:pointer;
    font-weight:600;
  }
  .btn.ok{background:var(--ok)}
  .btn.ghost{
    background:transparent;
    border:1px solid var(--line);
    color:var(--muted);
  }
  .btn:disabled{opacity:.6;cursor:not-allowed}

  .msg{margin:12px 0;padding:12px;border-radius:10px}
  .okbox{
    background:var(--ok-bg);
    border:1px solid var(--ok-border);
    color:var(--ok-text);
  }
  .errbox{
    background:var(--err-bg);
    border:1px solid var(--err-border);
    color:var(--err-text);
  }
  .warnbox{
    background:var(--warn-bg);
    border:1px solid var(--warn-border);
    color:var(--warn-text);
  }

  .progress{
    height:10px;
    background:var(--surface);
    border:1px solid var(--line);
    border-radius:999px;
    overflow:hidden;
  }
  .bar{
    height:100%;
    width:0%;
    background:linear-gradient(90deg, #6d28d9, #10b981);
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="header">
      <div class="header-main">
        <h1>Question√°rio para Identifica√ß√£o de Indicadores de Altas Habilidades/Superdota√ß√£o</h1>
        <p class="muted">Responda com sinceridade, com base na sua experi√™ncia real. N√£o existem respostas certas ou erradas.</p>
      </div>
      <button id="themeToggle" class="theme-btn" type="button">üåô Modo escuro</button>
    </div>

    <div class="legend">
      <span class="pill">Habilidade acima da m√©dia</span>
      <span class="pill">Criatividade</span>
      <span class="pill">Comprometimento</span>
      <span class="pill">Lideran√ßa/Socioemocional</span>
      <span class="pill">Artes/Esportes</span>
    </div>

    <div id="pacInfo" class="grid-info" style="display:none;"></div>

    <div id="progressWrap" style="display:none; gap:8px; align-items:center; margin:8px 0 0;">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:6px">
        <span class="muted" id="progressText">Progresso: 0/73</span>
        <button id="clearDraft" class="btn ghost" type="button" title="Limpar rascunho local">Limpar rascunho</button>
      </div>
      <div class="progress"><div class="bar" id="bar"></div></div>
    </div>

    <form id="form" style="margin-top:14px; display:none;" novalidate>
      <div id="qs"></div>
      <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap">
        <button id="btnSubmit" class="btn ok" type="submit">Enviar respostas</button>
        <button id="btnSave" class="btn ghost" type="button" title="Salvar rascunho">Salvar rascunho</button>
      </div>
      <div id="msg" class="msg" style="display:none" role="alert" aria-live="polite"></div>
    </form>

    <div id="alert" class="msg" style="display:none" role="alert" aria-live="assertive"></div>
  </div>
</div>

<script>
/* ===== CONFIG ===== */
const SHEETDB_BASE = "https://sheetdb.io/api/v1/8pmdh33s9fvy8";
const SHEETS = { PATIENTS:"Patients", TOKENS:"LinkTokens", SCORES:"Scores_QIIAHSD_ADULTO" };
const CODE = "QIIAHSD_ADULTO";
const PORTAL_URL = "https://integradaneuropsicologia.github.io/formularios/";
const RELEASE_KEYS = ["QIIAHSD_ADULTO"];

/* ===== HELPERS ===== */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const onlyDigits = s => (s||"").replace(/\D+/g,"");
const qs = k => new URLSearchParams(location.search).get(k) || "";

function setBox(id, text, kind="ok"){
  const el=$(id); if(!el) return;
  el.textContent = text;
  el.className = "msg " + (kind==="ok"?"okbox":kind==="warn"?"warnbox":"errbox");
  el.style.display = "block";
}
function hideBox(id){
  const el=$(id);
  if(el){
    el.style.display="none";
    el.textContent="";
  }
}
async function GET(url){
  const r=await fetch(url);
  if(!r.ok) throw new Error("HTTP "+r.status);
  return r.json();
}
async function sheetSearch(sheet, params){
  const usp = new URLSearchParams(params);
  return GET(`${SHEETDB_BASE}/search?sheet=${encodeURIComponent(sheet)}&${usp.toString()}`);
}
async function sheetCreate(sheet, row){
  const r = await fetch(`${SHEETDB_BASE}?sheet=${encodeURIComponent(sheet)}`, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ data:[row] })
  });
  if(!r.ok) throw new Error(await r.text());
  return r.json();
}
async function sheetPatchBy(sheet, column, value, data){
  const r = await fetch(`${SHEETDB_BASE}/${encodeURIComponent(column)}/${encodeURIComponent(value)}?sheet=${encodeURIComponent(sheet)}`, {
    method:"PATCH",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ data })
  });
  if(!r.ok) throw new Error(await r.text());
  return r.json();
}

const TOKEN = qs("token");

function goPortalWithToken(){
  try{
    const u = new URL(PORTAL_URL, location.href);
    if (TOKEN) u.searchParams.set("token", TOKEN);
    location.href = u.toString();
  }catch(_){
    const sep = PORTAL_URL.includes("?") ? "&" : "?";
    location.href = PORTAL_URL + (TOKEN ? sep + "token=" + encodeURIComponent(TOKEN) : "");
  }
}

/* ===== TEMA CLARO/ESCURO ===== */
const THEME_KEY = "qii_ahsd_adulto_theme";

function applyTheme(theme){
  const root = document.documentElement;
  root.setAttribute("data-theme", theme);
  const btn = document.querySelector("#themeToggle");
  if(btn){
    btn.textContent = theme === "dark" ? "‚òÄÔ∏è Modo claro" : "üåô Modo escuro";
  }
}

function initTheme(){
  let theme = "light";
  try{
    const saved = localStorage.getItem(THEME_KEY);
    if(saved === "dark" || saved === "light") theme = saved;
  }catch(_){}
  applyTheme(theme);

  const btn = document.querySelector("#themeToggle");
  if(btn){
    btn.addEventListener("click", ()=>{
      const current = document.documentElement.getAttribute("data-theme") || "light";
      const next = current === "dark" ? "light" : "dark";
      applyTheme(next);
      try{ localStorage.setItem(THEME_KEY, next); }catch(_){}
    });
  }
}

if(document.readyState === "loading"){
  document.addEventListener("DOMContentLoaded", initTheme);
} else {
  initTheme();
}

/* ===== ESCALAS ===== */
const LIKERT = [
  {v:0,l:'Nunca'},
  {v:1,l:'Raramente'},
  {v:2,l:'√Äs vezes'},
  {v:3,l:'Frequentemente'},
  {v:4,l:'Sempre'}
];
const TRI = [
  {v:0,l:'N√£o'},
  {v:2,l:'Em parte / depende'},
  {v:4,l:'Sim'}
];
const HOURS = [
  {v:0,l:'0‚Äì1 h/sem'},
  {v:1,l:'2‚Äì4 h/sem'},
  {v:2,l:'5‚Äì9 h/sem'},
  {v:3,l:'10‚Äì20 h/sem'},
  {v:4,l:'>20 h/sem'}
];

/* ===== ITENS ===== */
const AREAS_TAGS = [
  "Linguagem","Matem√°tica","Ci√™ncias","Tecnologia","Artes visuais","M√∫sica",
  "Esportes","Hist√≥ria","Filosofia","Programa√ß√£o","Xadrez/Estrat√©gia","Escrita/Cria√ß√£o","Lideran√ßa/Projetos","Outros"
];
const MELHORES_TAGS = [
  "L√≠ngua Portuguesa","Matem√°tica","Ci√™ncias/Engenharia","Tecnologia/Computa√ß√£o","Artes","M√∫sica","Esporte","Lideran√ßa/Projetos","Comunica√ß√£o","Outros"
];

const ITEMS = [
  {id:"hdr0", type:"section", text:"Hist√≥rico de leitura e interesses"},
  {id:"1", type:"single", text:"Com quantos anos come√ßou a ler?", options:[
    {label:"< 5 anos", value:4},
    {label:"5 anos", value:3},
    {label:"6 anos", value:2},
    {label:"7‚Äì8 anos", value:1},
    {label:"> 8 anos", value:0}
  ]},
  {id:"2A", type:"likert", text:"Eu leio por interesse pr√≥prio."},
  {id:"2B", type:"hours", text:"Leitura por interesse ‚Äî horas/semana."},
  {id:"3", type:"checkbox", text:"Assuntos/atividades preferidos (marque ‚â•3 se poss√≠vel).", checkboxes:AREAS_TAGS},
  {id:"4", type:"single", text:"Idade dos 4 melhores amigos (predominante).", options:[
    {label:"Maioria da mesma idade", value:1},
    {label:"Mistura (alguns ¬±2 anos)", value:2},
    {label:"Maioria +3 a +6 anos (mais velhos)", value:3},
    {label:"Maioria >6 anos mais velhos", value:4},
    {label:"Maioria mais novos", value:2}
  ]},
  {id:"5", type:"checkbox", text:"Em quais √°reas voc√™ era/√© um dos melhores (at√© 4).", checkboxes:MELHORES_TAGS},

  {id:"hdr1", type:"section", text:"Lideran√ßa / Socioemocional ‚Äî experi√™ncias e tra√ßos"},
  {id:"6", type:"likert", text:"Sente-se diferente/deslocado √†s vezes?"},
  {id:"7", type:"likert", text:"Prefere trabalhar/estudar sozinho?"},
  {id:"8", type:"likert", text:"Quando crian√ßa, lia livros dif√≠ceis/enciclop√©dias/atlas?"},
  {id:"9", type:"likert", text:"Independente para pensar e agir?"},
  {id:"10", type:"likert", text:"Senso de humor ‚Äúdiferente‚Äù em situa√ß√µes n√£o humor√≠sticas?"},
  {id:"11", type:"likert", text:"Preocupa√ß√£o √©tica/moral/social/pol√≠tica/ambiental?"},
  {id:"12", type:"likert", text:"Perfeccionista?"},
  {id:"13", type:"likert", text:"Mais observador(a) que os demais?"},
  {id:"14", type:"likert", text:"Prefere xadrez/jogos de estrat√©gia?"},
  {id:"15", type:"likert", text:"Princ√≠pios √©ticos/morais pr√≥prios aplicados sempre?"},
  {id:"16", type:"likert", text:"Conceito de amizade diferente?"},
  {id:"17", type:"likert", text:"Intolerante com atitudes que considera inadequadas?"},
  {id:"18", type:"single", text:"Quando crian√ßa, preferia amigos‚Ä¶", options:[
    {label:"Mais velhos", value:4},
    {label:"Tanto faz", value:2},
    {label:"Mesma idade", value:1},
    {label:"Mais novos", value:2}
  ]},

  {id:"hdr2", type:"section", text:"Habilidade acima da m√©dia (H) e Criatividade (C)"},
  {id:"19", type:"likert", text:"Mem√≥ria muito destacada para temas de interesse."},
  {id:"20", type:"likert", text:"Muita informa√ß√£o acumulada nos temas de interesse."},
  {id:"21", type:"likert", text:"Vocabul√°rio mais avan√ßado/rico nos temas de interesse."},
  {id:"22", type:"likert", text:"Entende coisas complexas ‚Äúpor partes‚Äù."},
  {id:"23", type:"likert", text:"Aprende r√°pido o que interessa e transfere para outras √°reas."},
  {id:"24", type:"likert", text:"Percebe rapidamente rela√ß√µes parte‚Äìtodo."},
  {id:"25", type:"likert", text:"Extrai mais de um sentido de hist√≥rias/filmes etc."},
  {id:"26", type:"likert", text:"Pergunta o ‚Äúcomo‚Äù e ‚Äúpor qu√™‚Äù com perguntas inteligentes."},
  {id:"27", type:"likert", text:"Tinha notas melhores que as da turma."},
  {id:"28", type:"likert", text:"Aprende mais r√°pido que os demais (especialmente no que interessa)."},
  {id:"29", type:"likert", text:"Adapta-se a situa√ß√µes novas ou as modifica."},
  {id:"30", type:"likert", text:"Pensamento abstrato muito desenvolvido."},

  {id:"31", type:"likert", text:"Ideias vistas como diferentes/esquisitas pelos demais."},
  {id:"32", type:"likert", text:"Muito curioso(a)."},
  {id:"33", type:"likert", text:"Muitas ideias/solu√ß√µes/respostas incomuns e inteligentes."},
  {id:"34", type:"likert", text:"Gosta de arriscar para conseguir o que quer."},
  {id:"35", type:"likert", text:"Gosta de enfrentar desafios."},
  {id:"36", type:"likert", text:"Muito imaginativo(a)/inventivo(a)."},
  {id:"37", type:"likert", text:"Sens√≠vel √†s coisas bonitas."},

  {id:"38", type:"likert", text:"Inconformista e n√£o se importa em ser diferente."},
  {id:"39", type:"likert", text:"Compreende ideias diferentes das suas."},
  {id:"40", type:"likert", text:"Fica chateado ao repetir algo que j√° sabe."},
  {id:"41", type:"likert", text:"Descobre novos caminhos para resolver problemas."},
  {id:"42", type:"likert", text:"Critica construtivamente e questiona autoritarismo."},
  {id:"43", type:"likert", text:"Presta aten√ß√£o mesmo que o assunto n√£o interesse.", invert:true},
  {id:"44", type:"likert", text:"Cadernos completos e organizados.", invert:true},
  {id:"45", type:"likert", text:"Gosta de cumprir regras.", invert:true},

  {id:"hdr3", type:"section", text:"Comprometimento com a tarefa (T)"},
  {id:"46", type:"likert", text:"Dedica muito mais tempo/energia ao que gosta."},
  {id:"47", type:"likert", text:"Muito exigente e cr√≠tico consigo."},
  {id:"48", type:"likert", text:"Insiste em buscar solu√ß√µes."},
  {id:"49", type:"likert", text:"Tem sua pr√≥pria organiza√ß√£o."},
  {id:"50", type:"likert", text:"Muito seguro e √†s vezes teimoso nas convic√ß√µes."},
  {id:"51", type:"likert", text:"Precisa de muito est√≠mulo para terminar algo que lhe interessa.", invert:true},
  {id:"52", type:"likert", text:"Deixa outras coisas para mergulhar no que interessa."},
  {id:"53", type:"likert", text:"Reconhece obst√°culos quando planeja."},
  {id:"54", type:"likert", text:"Sabe estabelecer prioridades com facilidade."},
  {id:"55", type:"likert", text:"Define etapas/detalhes/m√©todos para uma atividade."},
  {id:"56", type:"likert", text:"Persistente nas atividades de interesse (conclui tarefas)."},
  {id:"57", type:"likert", text:"Interessado e eficiente na organiza√ß√£o de tarefas."},

  {id:"hdr4", type:"section", text:"Autonomia e Lideran√ßa (L)"},
  {id:"58", type:"likert", text:"Distingue consequ√™ncias e efeitos das a√ß√µes. (H tamb√©m usa este item)"},
  {id:"59", type:"likert", text:"Autossuficiente."},
  {id:"60", type:"likert", text:"√â escolhido/preferido para lideran√ßa."},
  {id:"61", type:"likert", text:"Cooperativo com os demais."},
  {id:"62", type:"likert", text:"Tende a organizar o grupo."},
  {id:"63", type:"likert", text:"Persuasivo e sabe convencer."},

  {id:"hdr5", type:"section", text:"Artes / Esportes (A) ‚Äî marque se tem destaque"},
  {id:"64", type:"tri", text:"Artes visuais (pintura, desenho, fotografia etc.) ‚Äî destaque?"},
  {id:"65", type:"tri", text:"M√∫sica/Canto ‚Äî destaque?"},
  {id:"66", type:"tri", text:"Dan√ßa ‚Äî destaque?"},
  {id:"67", type:"tri", text:"Inform√°tica/Tecnologia ‚Äî destaque?"},
  {id:"68", type:"tri", text:"Esportes/Artes marciais/Gin√°stica ‚Äî destaque?"},
  {id:"69", type:"tri", text:"Teatro ‚Äî destaque?"},
  {id:"70", type:"tri", text:"Outra atividade ‚Äî destaque?"},
  {id:"70txt", type:"text", text:"Se marcou 'Outra atividade', qual? (texto opcional)"},
  {id:"71", type:"tri", text:"J√° obteve distin√ß√£o/premia√ß√£o nessas atividades?"},
  {id:"72", type:"hours", text:"Horas/semana dedicadas √†s atividades art√≠sticas/esportivas."}
];

/* ===== DOM√çNIOS ===== */
const H_IDS = ["1","2A","2B","14","19","20","21","22","23","24","25","26","27","28","29","30","39","58"];
const C_IDS = ["31","32","33","34","35","36","37","40","41","42"];
const T_IDS = ["46","47","48","49","50","51","52","53","54","55","56","57"];
const L_IDS = [
  "59","60","61","62","63",
  "6","7","8","9","10","11","12","13","15","16","17","18",
  "43","44","45"
];
const A_IDS = ["64","65","66","67","68","69","70","71","72"];

const H_SET = new Set(H_IDS);
const C_SET = new Set(C_IDS);
const T_SET = new Set(T_IDS);
const L_SET = new Set(L_IDS);
const A_SET = new Set(A_IDS);

/* ===== ESTADO ===== */
let patient=null, tokenRow=null, CPF="";
const STORAGE_KEY = `AHSD_${TOKEN || 'anon'}`;
let startAt = Date.now();

/* ===== RENDER ===== */
function renderQuestions(){
  const host = $("#qs"); host.innerHTML = "";
  for(const it of ITEMS){
    if(it.type==="section"){
      const s=document.createElement('div');
      s.className='section';
      s.textContent=it.text;
      host.appendChild(s);
      continue;
    }

    const row = document.createElement('div');
    row.className='item';
    row.dataset.q = it.id;

    const stem = document.createElement('div');
    stem.className='stem';
    stem.id = `s_${it.id}`;
    stem.textContent = `${it.id}. ${it.text}`;
    row.appendChild(stem);

    if(it.type==="likert" || it.type==="tri" || it.type==="hours" || it.type==="single"){
      const choices = document.createElement('div');
      choices.className='choices';
      const base = it.type==="likert" ? LIKERT
                : it.type==="tri"   ? TRI
                : it.type==="hours" ? HOURS
                : it.options;
      base.forEach(opt=>{
        const lab = document.createElement('label');
        lab.className='opt';
        lab.setAttribute('title', opt.label || opt.l);
        const id = `q_${it.id}_${opt.value ?? opt.v}`;
        const val = opt.value ?? opt.v;
        lab.innerHTML = `
          <input type="radio"
                 name="q_${it.id}"
                 id="${id}"
                 value="${val}"
                 required
                 aria-labelledby="s_${it.id}">
          <span>${opt.label || opt.l}</span><small></small>`;
        choices.appendChild(lab);
      });
      row.appendChild(choices);
    }

    if(it.type==="checkbox"){
      const wrap = document.createElement('div');
      wrap.className='chips';
      it.checkboxes.forEach((name,ix)=>{
        const id = `q_${it.id}_${ix}`;
        const lab = document.createElement('label');
        lab.className='chip';
        lab.innerHTML =
          `<input type="checkbox" name="q_${it.id}" id="${id}" value="${name}">
           <span>${name}</span>`;
        wrap.appendChild(lab);
      });
      const hint = document.createElement('div');
      hint.className='muted';
      hint.style.marginTop='6px';
      hint.textContent = "";
      row.appendChild(wrap);
      row.appendChild(hint);
    }

    if(it.type==="text"){
      const r = document.createElement('div');
      r.className='row';
      r.innerHTML = `<input type="text" id="q_${it.id}" placeholder="Digite aqui (opcional)"/>`;
      row.appendChild(r);
    }

    host.appendChild(row);
  }
}

/* ===== STORAGE / PROGRESS ===== */
function saveDraft(){
  const data = {};
  for(const it of ITEMS){
    if(it.type==="section") continue;
    if(it.type==="checkbox"){
      data[it.id] = $$(`input[name="q_${it.id}"]:checked`).map(e=>e.value);
    }else if(it.type==="text"){
      data[it.id] = $(`#q_${it.id}`)?.value || "";
    }else{
      const sel = $(`input[name="q_${it.id}"]:checked`);
      if(sel) data[it.id] = Number(sel.value);
    }
  }
  try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }catch(e){}
}
function restoreDraft(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return;
    const data = JSON.parse(raw);
    for(const [id,val] of Object.entries(data||{})){
      const it = ITEMS.find(x=>x.id===id);
      if(!it) continue;
      if(it.type==="checkbox"){
        (val||[]).forEach(v=>{
          const el = $$(`input[name="q_${id}"]`).find(e=>e.value===v);
          if(el) el.checked = true;
        });
      }else if(it.type==="text"){
        const el = $(`#q_${id}`);
        if(el) el.value = val;
      }else{
        const el = $(`input[name="q_${id}"][value="${val}"]`);
        if(el) el.checked = true;
      }
    }
  }catch(_){}
}
function clearDraft(){
  try { localStorage.removeItem(STORAGE_KEY); } catch (_){}
}
function countAnswered(){
  let c=0;
  for(const it of ITEMS){
    if(it.type==="section") continue;
    if(it.type==="text") continue; // texto √© opcional
    if(it.type==="checkbox"){
      if($$(`input[name="q_${it.id}"]:checked`).length>0) c++;
    }else{
      if($(`input[name="q_${it.id}"]:checked`)) c++;
    }
  }
  return c;
}
function updateProgress(){
  const totalReq = ITEMS.filter(it=>it.type!=="section" && it.type!=="text").length;
  const answered = countAnswered();
  $("#progressText").textContent = `Progresso: ${answered}/${totalReq}`;
  $("#bar").style.width = `${(answered/totalReq)*100}%`;
}

/* ===== SCORING ===== */
function valueOf(id){
  const it = ITEMS.find(x=>x.id===id);
  if(!it) return 0;
  if(it.type==="checkbox"){
    const n = $$(`input[name="q_${id}"]:checked`).length;
    return Math.min(n, 4);
  }
  if(it.type==="text"){
    return 0;
  }
  const sel = $(`input[name="q_${id}"]:checked`);
  if(!sel) return 0;
  let val = Number(sel.value);
  if(it.type==="likert" && it.invert){
    val = 4 - val;
  }
  return val;
}
function sumIds(arr){
  return arr.reduce((s,id)=> s + valueOf(id), 0);
}

function scoreA(){
  const base = ["64","65","66","67","68","69","70"].reduce((s,id)=> s + valueOf(id), 0);
  const capBase = Math.min(base, 8);
  const prem = Math.min(valueOf("71"), 4);
  const hrs = Math.min(valueOf("72"), 4);
  return capBase + prem + hrs; // max 16
}

const H_MAX = 4 * H_IDS.length; // 18*4 = 72
const C_MAX = 4 * C_IDS.length; // 10*4 = 40
const T_MAX = 4 * T_IDS.length; // 12*4 = 48
const L_MAX = 4 * L_IDS.length; // 21*4 = 84
const A_MAX = 16;

function totalAndMax(){
  const allIds = ITEMS
    .map(i=>i.id)
    .filter(id => !["64","65","66","67","68","69","70","71","72","70txt"].includes(id) && !id.startsWith("hdr"));
  let t = 0;
  for(const id of allIds){
    t += valueOf(id);
  }
  t += scoreA();

  let m = 0;
  for(const id of allIds){
    const it = ITEMS.find(x=>x.id===id);
    if(!it) continue;
    if(it.type==="text"||it.type==="section") continue;
    m += 4;
  }
  m += A_MAX;

  return {total:t, max:m};
}

function classify(indexPct, hPct, cPct, tPct){
  let cls =
    (indexPct >= 75)
      ? "Perfil muito consistente com AH/SD: converg√™ncia robusta entre itens e 2 de 3 dom√≠nios centrais (Habilidade acima da m√©dia/Criatividade/Envolvimento com a tarefa) ‚â•65% ‚Äî frequentemente os tr√™s. A pessoa aprende muito r√°pido, cria solu√ß√µes originais e sustenta dedica√ß√£o quando h√° desafio."
      : (indexPct >= 60)
      ? "Ind√≠cios fortes de AH/SD: padr√£o consistente em m√∫ltiplos itens, normalmente com Habilidades acima da m√©dia e/ou Criatividade altos e Envolvimento com a tarefa moderado-alto. O perfil j√° aparece na pr√°tica (aprendizagem r√°pida, conex√µes incomuns, autonomia)."
      : (indexPct >= 40)
      ? "Potencial presente: h√° sinais parciais; geralmente 1‚Äì2 dom√≠nios acima (ex.: Habilidade acima da m√©dia e/ou Criatividade) com Envolvimento com a tarefa mediano. √â um perfil com mat√©ria-prima (curiosidade, vocabul√°rio, mem√≥ria, conex√µes r√°pidas) que ainda n√£o virou desempenho constante."
      : "Poucos ind√≠cios: as respostas n√£o sustentam um perfil amplo de AH/SD neste momento. Pode haver talentos pontuais, mas o padr√£o n√£o √© consistente entre Habilidade acima da m√©dia/Criatividade/Envolvimento com a tarefa.";

  const strongCount = [hPct, cPct, tPct].filter(p=>p>=65).length;
  if((cls.startsWith("Perfil") || cls.startsWith("Ind√≠cios")) && strongCount < 2){
    cls = "Potencial presente (recomenda-se avalia√ß√£o aprofundada)";
  }
  return cls;
}

/* ===== QUESTIONS (JSON audit√°vel) ===== */
function getOptionsForItem(it){
  if(it.type==="likert"){
    return LIKERT.map(o=>({value:String(o.v),label:o.l}));
  }else if(it.type==="tri"){
    return TRI.map(o=>({value:String(o.v),label:o.l}));
  }else if(it.type==="hours"){
    return HOURS.map(o=>({value:String(o.v),label:o.l}));
  }else if(it.type==="single"){
    return it.options.map(o=>({value:String(o.value),label:o.label}));
  }
  return [];
}

function getAnswerLabelForItem(it){
  if(it.type==="checkbox"){
    const vals = $$(`input[name="q_${it.id}"]:checked`).map(e=>e.value);
    if(vals.length === 0) return "";
    return vals.join(", ");
  }
  if(it.type==="text"){
    const v = $(`#q_${it.id}`)?.value?.trim() || "";
    return v;
  }

  const sel = $(`input[name="q_${it.id}"]:checked`);
  if(!sel) return "";
  const val = String(sel.value);
  const opts = getOptionsForItem(it);
  const match = opts.find(o=>o.value===val);
  return match ? match.label : val;
}

function collectQuestionsAnswersJSON(){
  const arr = [];
  for(const it of ITEMS){
    if(it.type==="section") continue;
    const qText = `${it.id}. ${it.text}`;
    let value = null;
    let label = "";

    if(it.type==="checkbox"){
      const vals = $$(`input[name="q_${it.id}"]:checked`).map(e=>e.value);
      value = vals;
      label = vals.join(", ");
    }else if(it.type==="text"){
      const v = $(`#q_${it.id}`)?.value?.trim() || "";
      value = v;
      label = v;
    }else{
      const sel = $(`input[name="q_${it.id}"]:checked`);
      if(sel){
        value = Number(sel.value);
        label = getAnswerLabelForItem(it);
      }
    }

    const domains = {
      H: H_SET.has(it.id),
      C: C_SET.has(it.id),
      T: T_SET.has(it.id),
      L: L_SET.has(it.id),
      A: A_SET.has(it.id)
    };

    arr.push({
      id: it.id,
      text: qText,
      type: it.type,
      value,
      label,
      domains
    });
  }
  return arr;
}

/* ===== BOOT ===== */
(async function boot(){
  try{
    if(!TOKEN){
      setBox("#alert","Link inv√°lido (sem token). Solicite um novo link.","err");
      return;
    }

    const trows = await sheetSearch(SHEETS.TOKENS, { token: TOKEN });
    if(!trows || !trows.length) throw new Error("Token inv√°lido ou expirado.");
    tokenRow = trows[0];
    if(String(tokenRow.disabled||"n√£o").toLowerCase()==="sim")
      throw new Error("Token desativado. Pe√ßa um novo link.");
    if(tokenRow.expires_at && new Date(tokenRow.expires_at) < new Date())
      throw new Error("Token expirado. Pe√ßa um novo link.");
    CPF = onlyDigits(tokenRow.cpf||"");
    if(!CPF) throw new Error("Token sem CPF vinculado.");

    const prows = await sheetSearch(SHEETS.PATIENTS, { cpf: CPF });
    if(!prows || !prows.length) throw new Error("Paciente n√£o encontrado.");
    patient = prows[0];

    const isAllowed = RELEASE_KEYS.some(k =>
      String(patient[k]||"").trim().toLowerCase()==="sim"
    );
    if(!isAllowed){
      setBox("#alert","Este formul√°rio n√£o est√° liberado para voc√™.","err");
      return;
    }

    const doneKeys = RELEASE_KEYS.map(k => `${k}_FEITO`);
    const anyDoneFlag = doneKeys.some(k =>
      String(patient[k]||"").trim().toLowerCase()==="sim"
    );
    const already = await sheetSearch(SHEETS.SCORES, { cpf: CPF, code: CODE });
    if(anyDoneFlag || (already && already.length)){
      setBox("#alert","Voc√™ j√° respondeu este formul√°rio. Voltando ao portal‚Ä¶","ok");
      setTimeout(goPortalWithToken, 1200);
      return;
    }

    renderPatientInfo();
    renderQuestions();
    restoreDraft();
    updateProgress();

    $("#pacInfo").style.display = "grid";
    $("#form").style.display = "block";
    $("#progressWrap").style.display = "block";
    hideBox("#alert");

    startAt = Date.now();

  }catch(err){
    console.error(err);
    setBox("#alert", err.message || "Falha ao abrir o formul√°rio. Tente novamente mais tarde.", "err");
  }
})();

function renderPatientInfo(){
  const g = $("#pacInfo"); g.innerHTML="";
  const info = [
    ["Nome", patient.nome || "-"],
    ["WhatsApp", patient.whatsapp || "-"]
  ];
  for(const [k,v] of info){
    const div = document.createElement("div");
    div.className = "info";
    div.innerHTML = `<b>${k}</b><div>${v||"-"}</div>`;
    g.appendChild(div);
  }
}

/* ===== UI EVENTS ===== */
addEventListener('change', (e)=>{
  if(
    e.target &&
    (e.target.matches('input[type="radio"]')
     || e.target.matches('input[type="checkbox"]')
     || e.target.matches('input[type="text"]'))
  ){
    saveDraft();
    updateProgress();
  }
});
$("#btnSave").addEventListener('click', ()=>{
  saveDraft();
  setBox('#msg','Rascunho salvo neste dispositivo.','ok');
});
$("#clearDraft").addEventListener('click', ()=>{
  clearDraft();
  setBox('#msg','Rascunho apagado.','warn');
  updateProgress();
});

/* ===== SUBMIT ===== */
let sending=false;
$("#form").addEventListener("submit", async (e)=>{
  e.preventDefault();
  if(sending) return;
  sending = true;
  hideBox("#msg");

  const btn = $("#btnSubmit");
  const originalText = btn.textContent;
  btn.disabled = true;
  btn.textContent = "Enviando‚Ä¶";

  try{
    if(!patient) throw new Error("Sess√£o inv√°lida. Recarregue o link.");

    // valida√ß√£o (tudo exceto texto opcional 70txt)
    for(const it of ITEMS){
      if(it.type==="section"||it.type==="text") continue;
      if(it.type==="checkbox"){
        if($$(`input[name="q_${it.id}"]:checked`).length===0){
          const row = $(`.item[data-q="${it.id}"]`);
          if(row) row.scrollIntoView({behavior:'smooth', block:'center'});
          throw new Error(`Marque ao menos uma op√ß√£o no item ${it.id}.`);
        }
      }else{
        const sel = $(`input[name="q_${it.id}"]:checked`);
        if(!sel){
          const row = $(`.item[data-q="${it.id}"]`);
          if(row) row.scrollIntoView({behavior:'smooth', block:'center'});
          throw new Error(`Responda o item ${it.id}.`);
        }
      }
    }

    // Anti-duplicidade extra
    const again = await sheetSearch(SHEETS.SCORES, { cpf: CPF, code: CODE });
    if(again && again.length){
      setBox("#msg","Este formul√°rio j√° foi enviado anteriormente. Voltando ao portal‚Ä¶","ok");
      setTimeout(goPortalWithToken,1000);
      return;
    }

    // dom√≠nios
    const H = sumIds(H_IDS);
    const C = sumIds(C_IDS);
    const T = sumIds(T_IDS);
    const L = sumIds(L_IDS);
    const A = scoreA();

    const {total, max} = totalAndMax();
    const idx  = max ? Math.round((total/max)*100) : 0;
    const hPct = Math.round((H/H_MAX)*100);
    const cPct = Math.round((C/C_MAX)*100);
    const tPct = Math.round((T/T_MAX)*100);
    const lPct = Math.round((L/L_MAX)*100);
    const aPct = Math.round((A/A_MAX)*100);

    const cls = classify(idx, hPct, cPct, tPct);
    const categoria_csv = `Classificacao=${cls.replace(/,/g,";")}`;

    // dura√ß√£o do preenchimento
    const durationSec = Math.round((Date.now() - startAt)/1000);

    // m√©tricas completas (JSON na coluna metrics)
    const metricsObj = {
      index_percent: idx,
      classification: cls,
      raw_scores: {
        HabilidadeAcimaMedia: H,
        Criatividade: C,
        Comprometimento: T,
        LiderancaSocioemocional: L,
        ArtesEsportes: A
      },
      max_scores: {
        H_MAX, C_MAX, T_MAX, L_MAX, A_MAX
      },
      percents: {
        H_pct: hPct,
        C_pct: cPct,
        T_pct: tPct,
        L_pct: lPct,
        A_pct: aPct
      },
      total_raw: total,
      total_max: max,
      duration_sec: durationSec
    };

    const questionsArr = collectQuestionsAnswersJSON();

    await sheetCreate(SHEETS.SCORES, {
      result_id: `${patient.cpf}_${CODE}_${Date.now()}`,
      token: TOKEN,
      cpf: patient.cpf,
      code: CODE,
      source: "paciente",
      submitted_at: new Date().toISOString(),
      total: "",
      categoria: cls,
      metrics: "",
      questions: JSON.stringify(questionsArr)
    });

    const doneUpdates = {};
    RELEASE_KEYS.map(k=>`${k}_FEITO`).forEach(k=>{
      if(k in patient) doneUpdates[k] = "sim";
    });
    if(Object.keys(doneUpdates).length===0){
      doneUpdates[`${RELEASE_KEYS[0]}_FEITO`] = "sim";
    }
    await sheetPatchBy(SHEETS.PATIENTS, "cpf", patient.cpf, doneUpdates);

    clearDraft();
    setBox("#msg","Formul√°rio enviado. Voltando ao portal‚Ä¶","ok");
    setTimeout(goPortalWithToken, 1100);

  }catch(err){
    console.error(err);
    setBox("#msg", err.message || "Falha ao enviar. Tente novamente.", "err");

    sending = false;
    btn.disabled = false;
    btn.textContent = originalText;
  }
});
</script>

</body>
</html>
